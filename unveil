#!/bin/sh

dir=${SECRETS:="$HOME/secrets"}
fingerprint=${PGPFINGERPRINT:=""}

creset='\033[0m'
cdir='\033[1;36m'
ctitle='\033[1m'

# Prints $1 to stderr.
stderr() {
	echo "$1" >&2
}

# Dies printing usage.
usage() {
	stderr "Usage: $0 get <secret>"
	stderr "Usage: $0 ls"
	exit 1
}

# List files ending in ".enc" in $1 in a formatted format using $2 as the
# prefix of each printed line, recursing directories and appending to $2 for
# each cycle to create an indentation effect. The ".enc" prefix is removed from
# file names.
list() {
	for f in "$1"/*; do
		b=$(basename "$f")

		if [ -d "$f" ]; then
			printf    "$2|- ${cdir}$b${creset}\n"
			list "$f" "$2|  "
		elif [ -f "$f" ]; then
			case "$b" in
			*.enc)
				printf    "$2|- ${b%.enc}\n"
				;;
			esac
		fi
	done
}

case "$1" in
get)
	if [ -z "$2" ]; then
		usage
	fi

	if [ -z "$fingerprint" ]; then
		stderr 'Environment variable PGPFINGERPRINT is not defined.'
		exit 1
	fi
	;;
ls)
	printf "${ctitle}Secrets${creset}\n"
	list "$dir" ""
	;;
*)
	usage
	;;
esac
